<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Mocking requests to third party services" /><meta name="author" content="Yiorgos Krypotos" /><meta property="og:locale" content="en" /><meta name="description" content="Third party services are frequently used to extend the functionality of our product/service, especially in cases where what is needed grows beyond the limits of our industry or purpose. Once an integration is set up and running, naturally this must be included in our automation tests, right? (right?)" /><meta property="og:description" content="Third party services are frequently used to extend the functionality of our product/service, especially in cases where what is needed grows beyond the limits of our industry or purpose. Once an integration is set up and running, naturally this must be included in our automation tests, right? (right?)" /><link rel="canonical" href="https://1024inc.github.io/engineering-blog//posts/mocking-requests-to-third-party-services/" /><meta property="og:url" content="https://1024inc.github.io/engineering-blog//posts/mocking-requests-to-third-party-services/" /><meta property="og:site_name" content="Engineering @ Beyond" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-08-09T19:00:00-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Mocking requests to third party services" /><meta name="twitter:site" content="@BeyondPricing" /><meta name="twitter:creator" content="@Yiorgos Krypotos" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Yiorgos Krypotos"},"dateModified":"2022-08-10T05:28:29-05:00","datePublished":"2022-08-09T19:00:00-05:00","description":"Third party services are frequently used to extend the functionality of our product/service, especially in cases where what is needed grows beyond the limits of our industry or purpose. Once an integration is set up and running, naturally this must be included in our automation tests, right? (right?)","headline":"Mocking requests to third party services","mainEntityOfPage":{"@type":"WebPage","@id":"https://1024inc.github.io/engineering-blog//posts/mocking-requests-to-third-party-services/"},"url":"https://1024inc.github.io/engineering-blog//posts/mocking-requests-to-third-party-services/"}</script><title>Mocking requests to third party services | Engineering<br/> @ Beyond</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Engineering<br/> @ Beyond "><meta name="application-name" content="Engineering<br/> @ Beyond "><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/images/logo.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Engineering<br/> @ Beyond </a></div><div class="site-subtitle font-italic">Let's go Beyond together!</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/principles/" class="nav-link"> <i class="fa-fw fas fa-heartbeat ml-xl-3 mr-xl-3 unloaded"></i> <span>OUR PRINCIPLES</span> </a><li class="nav-item"> <a href="/obts/" class="nav-link"> <i class="fa-fw fas fa-users ml-xl-3 mr-xl-3 unloaded"></i> <span>DELIVERY TEAMS</span> </a><li class="nav-item"> <a href="/guilds/" class="nav-link"> <i class="fa-fw fas fa-lightbulb ml-xl-3 mr-xl-3 unloaded"></i> <span>GUILDS AND COMMUNITIES</span> </a><li class="nav-item"> <a href="/eng-paths/" class="nav-link"> <i class="fa-fw fas fa-users ml-xl-3 mr-xl-3 unloaded"></i> <span>ENGINEERING PATHS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/1024inc/" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/BeyondPricing" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['dev','beyondpricing.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Mocking requests to third party services</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Mocking requests to third party services</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Yiorgos Krypotos </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Tue, Aug 9, 2022, 7:00 PM -0500" >Aug 9, 2022<i class="unloaded">2022-08-09T19:00:00-05:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Wed, Aug 10, 2022, 1:28 PM +0300" >Aug 10, 2022<i class="unloaded">2022-08-10T05:28:29-05:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1477 words">8 min read</span></div></div><div class="post-content"><p>Third party services are frequently used to extend the functionality of our product/service, especially in cases where what is needed grows beyond the limits of our industry or purpose. Once an integration is set up and running, naturally this must be included in our automation tests, right? (right?)</p><p>It is a widely accepted practice to always mock requests made to third party services while testing, integration tests included. The reasoning behind this lies in 2 main areas:</p><ol><li>We don’t control the response we get. This may lead to flaky tests, our testing suite failing because of service unavailability etc. The negative impact is even greater when a CI/CD process is used to deploy to our production and staging environments. Not to mention hotfixes…<li>Tests may take a while, since a connection is in the middle of it. If our suite consists of hundreds or thousands of tests, this may add up to a horrible amount of time to complete the suite.</ol><p>So what are the best ways to mock those requests in our automated tests?</p><h2 id="sample-case">Sample case</h2><p>Let’s say that in our product, we deal with international customers who pay in different currencies and we want to convert everything to let’s say USD. To do so we can use the OpenExchange API. Here is a sample code to implement this:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span text-data=" Python "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">requests</span>

<span class="k">class</span> <span class="nc">ExchangeRatesClient</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="s">"https://open.er-api.com/v6/latest/"</span>

    <span class="k">def</span> <span class="nf">get_exchange_rates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">currency_code</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">base_url</span> <span class="o">+</span> <span class="n">currency_code</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">response</span><span class="p">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">.</span><span class="n">json</span><span class="p">()</span>
</pre></table></code></div></div><h2 id="good-ol-monkeypatch">Good ol’ monkeypatch</h2><p>Monkeypatch is a fixture from <a href="https://docs.pytest.org/">pytest</a> which allows us to easily patch attributes. In this case the <code class="language-plaintext highlighter-rouge">get()</code> function of <code class="language-plaintext highlighter-rouge">requests</code>.</p><p>Example:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span text-data=" Python "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">MockResponse</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json_data</span><span class="p">,</span> <span class="n">status_code</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">json_data</span> <span class="o">=</span> <span class="n">json_data</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>
    
    <span class="k">def</span> <span class="nf">json</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">json</span>
    
    <span class="k">def</span> <span class="nf">raise_for_status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span>

<span class="k">class</span> <span class="nc">TestExchangeRatesClient</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">test_get_exchange_rates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">monkeypatch</span><span class="p">):</span>
        <span class="c1">#assign
</span>        <span class="n">exchange_rates_client</span> <span class="o">=</span> <span class="n">ExchangeRatesClient</span><span class="p">()</span>
        <span class="n">expected_value</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">"result"</span><span class="p">:</span> <span class="s">"success"</span><span class="p">,</span>
            <span class="s">"base_code"</span><span class="p">:</span> <span class="s">"USD"</span><span class="p">,</span>
            <span class="s">"rates"</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">"USD"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s">"CAD"</span><span class="p">:</span> <span class="mf">1.26</span><span class="p">,</span>
                <span class="s">"CHF"</span><span class="p">:</span> <span class="mf">0.941</span><span class="p">,</span>
                <span class="s">"EUR"</span><span class="p">:</span> <span class="mf">0.923</span><span class="p">,</span>
                <span class="s">"GBP"</span><span class="p">:</span> <span class="mf">0.765</span><span class="p">,</span>
                <span class="s">"JPY"</span><span class="p">:</span> <span class="mf">125.9</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="n">mock_requests</span> <span class="o">=</span> <span class="n">Mock</span><span class="p">(</span>
            <span class="n">return_value</span> <span class="o">=</span> <span class="n">MockResponse</span><span class="p">(</span><span class="n">json_data</span> <span class="o">=</span> <span class="n">expected_value</span><span class="p">,</span> <span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">monkeypatch</span><span class="p">.</span><span class="nb">setattr</span><span class="p">(</span><span class="n">requests</span><span class="p">,</span> <span class="s">"get"</span><span class="p">,</span> <span class="n">mock_requests</span><span class="p">)</span>
        <span class="c1">#act
</span>        <span class="n">result</span> <span class="o">=</span> <span class="n">exchange_rates_client</span><span class="p">.</span><span class="n">get_exchange_rates</span><span class="p">(</span><span class="n">currency_code</span><span class="o">=</span><span class="s">"USD"</span><span class="p">)</span>
        <span class="c1">#assert
</span>        <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="n">expected_value</span>
</pre></table></code></div></div><h2 id="how-it-works">How it works:</h2><p>When requesting data, we get a <a href="https://requests.readthedocs.io/en/latest/api/#requests.Response">Response</a> object so we have to mock its behaviour. This is what the <code class="language-plaintext highlighter-rouge">class MockResponse</code> is doing. This class may change depending on how we use the response object. Eg. we may need to add a <code class="language-plaintext highlighter-rouge">text</code> attribute, or add logic to the <code class="language-plaintext highlighter-rouge">raise_for_error()</code> to mock its behaviour and raise an HTTPError in case of an invalid status_code (4xx-5xx)</p><p>PROS:</p><ul><li>Doesn’t depend on 3rd party libraries<li>Flexibility on implementing exotic cases when mocking</ul><p>CONS:</p><ul><li>In real life examples, the response object can be very complex (headers, huge reponses, cookies etc) which can make the MockResponse class a hairy mess<li>Monkeypatching has a global effect. If there were more requests we had to use side_effect and things could break.<li>If instead of requests.get we use requests.Session().get(), then monkeypatching goes bust.</ul><h2 id="requests-mock">Requests-mock</h2><p>From the solution above we see that there is a lot of logic inside the MockResponse which isn’t always pleasant and we may introduce more bugs. And it feels a little too custom of a solution for such a generic problem to solve. So yeah… you guessed it. There is a library for that. One of the mostly used libraries in the python world is <a href="https://requests-mock.readthedocs.io/en/latest/">requests-mock</a></p><p>Example</p><div class="language-python highlighter-rouge"><div class="code-header"> <span text-data=" Python "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">test_get_exchange_rates_with_requests_mock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># assign
</span>    <span class="n">exchange_rates_client</span> <span class="o">=</span> <span class="n">ExchangeRatesClient</span><span class="p">()</span>
    <span class="n">expected_value</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"result"</span><span class="p">:</span> <span class="s">"success"</span><span class="p">,</span>
        <span class="s">"base_code"</span><span class="p">:</span> <span class="s">"USD"</span><span class="p">,</span>
        <span class="s">"rates"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">"USD"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s">"CAD"</span><span class="p">:</span> <span class="mf">1.26</span><span class="p">,</span>
            <span class="s">"CHF"</span><span class="p">:</span> <span class="mf">0.941</span><span class="p">,</span>
            <span class="s">"EUR"</span><span class="p">:</span> <span class="mf">0.923</span><span class="p">,</span>
            <span class="s">"GBP"</span><span class="p">:</span> <span class="mf">0.765</span><span class="p">,</span>
            <span class="s">"JPY"</span><span class="p">:</span> <span class="mf">125.9</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>
    <span class="c1"># act
</span>    <span class="k">with</span> <span class="n">requests_mock</span><span class="p">.</span><span class="n">Mocker</span><span class="p">()</span> <span class="k">as</span> <span class="n">m</span><span class="p">:</span>
        <span class="n">m</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"https://open.er-api.com/v6/latest/USD"</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">expected_value</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">exchange_rates_client</span><span class="p">.</span><span class="n">get_exchange_rates</span><span class="p">(</span><span class="s">"USD"</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="n">expected_value</span>
</pre></table></code></div></div><h2 id="how-it-works-1">How it works</h2><p>Within the context manager, every request is being mocked by declaring it using the method and url. Regex can be used for more dynamic matching. If a request is not matched, then requests_mock will throw an exception and the test will fail, thus preventing the call to an external endpoint. Here, there are arguments as well to specify status_code, json, text etc depending on the desired response.</p><p>PROS</p><ul><li>Easy to use<li>Flexibility<li>Less code<li>Mock response objects have the desired behaviour by default</ul><p>CONS</p><ul><li>You need to explicitly take care of every request in terms of expected values<li>Hand written expected values</ul><h2 id="vcrpy">VCR.py</h2><p>Storming from Ruby’s VCR library, VCR.py <del>brings all the 80s nostalgia that we secretly crave for</del> is a neat and powerful library that takes away most of the pain. What it does is that it records every http request done inside a test and “writes” them in a (by default .yaml) file. This file is then reused every time a request needs to be mocked. If there are more than one requests, then it records them all and are exposed in the cassette.responses list.</p><p>Example</p><div class="language-python highlighter-rouge"><div class="code-header"> <span text-data=" Python "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">test_get_exchange_rates_with_vcr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># assign
</span>    <span class="n">exchange_rates_client</span> <span class="o">=</span> <span class="n">ExchangeRatesClient</span><span class="p">()</span>

    <span class="c1"># act
</span>    <span class="k">with</span> <span class="n">vcr</span><span class="p">.</span><span class="n">use_cassette</span><span class="p">(</span>
        <span class="s">"exchange_rates.yaml"</span><span class="p">,</span> <span class="n">serializer</span><span class="o">=</span><span class="s">"yaml"</span><span class="p">,</span> <span class="n">decode_compressed_response</span><span class="o">=</span><span class="bp">True</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">cassette</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">exchange_rates_client</span><span class="p">.</span><span class="n">get_exchange_rates</span><span class="p">(</span><span class="s">"USD"</span><span class="p">)</span>
    <span class="c1"># assert
</span>    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">cassette</span><span class="p">.</span><span class="n">responses</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">"body"</span><span class="p">][</span><span class="s">"string"</span><span class="p">])</span>
</pre></table></code></div></div><h2 id="how-it-works-2">How it works</h2><p>This library is very flexible and can be configured in many different ways.</p><h3 id="decorator-vs-context-manager">Decorator vs context manager</h3><p>First it can be used as a decorator to mock all requests within a test, or as a context manager to mock requests in a specific area inside the test, allowing to have different VCR objects per request with different configurations. The <code class="language-plaintext highlighter-rouge">vcr.use_cassette()</code> can be used to specify the file to write and/or the path of that file. Ex. <code class="language-plaintext highlighter-rouge">with vcr.use_cassette(“path/to/folder/exchange_rates.yaml”)</code></p><h3 id="record-modes">Record modes</h3><p>once (default) When a request is about to happen, it checks if the file exists. If not, it makes an actual request, and writes it into the file. IF the file exists already, it uses that file instead of the actual request. If the file exists but the request is different than the one that it is recorded in, then it raises an error. This is the most used record mode. Usually we make a real request (with api_keys etc) and then we remove the sensitive code (we can also filter headers, query_parameters as described here) If something goes wrong, then we can simply delete the .yaml file and run the test again.</p><p>none Never make a real http request. It is mostly used when we want to be absolutely sure that an http endpoint is never called because that endpoint is sensitive.</p><p>all Always make an http request. This mode is not for mocking but when we want to override an existing cassette without deleting the file or when we want to simply log requests (rare)</p><p>new_episodes Like the <code class="language-plaintext highlighter-rouge">once</code> mode, but in case there is a file with a similar request, it overrides it instead of raising an exception</p><h3 id="sample-configuration">Sample Configuration</h3><p>A very common blocker when first using this library is to create a generic configuration that all subsequent tests can easily use. Here is a personal favourite: a double wrapped func. Config file:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span text-data=" Python "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="c1"># here more params can be added
</span><span class="k">def</span> <span class="nf">vcr_cassette</span><span class="p">(</span><span class="n">cassette_path</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="o">@</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">conf_vcr</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="c1"># default config
</span>            <span class="n">vcr</span> <span class="o">=</span> <span class="n">VCR</span><span class="p">(</span>
                <span class="n">record_mode</span><span class="o">=</span><span class="n">record_mode</span><span class="p">.</span><span class="n">RecordMode</span><span class="p">.</span><span class="n">ONCE</span><span class="p">,</span>
                <span class="n">decode_compressed_response</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">serializer</span><span class="o">=</span><span class="s">'yaml'</span><span class="p">,</span>
                <span class="n">cassette_library_dir</span><span class="o">=</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span> <span class="o">+</span> <span class="s">'/cassettes/'</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="k">with</span> <span class="n">vcr</span><span class="p">.</span><span class="n">use_cassette</span><span class="p">(</span><span class="n">cassette_path</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">conf_vcr</span>
    <span class="k">return</span> <span class="n">inner</span>
</pre></table></code></div></div><p>Usage:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span text-data=" Python "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="o">@</span><span class="n">vcr_cassette</span><span class="p">(</span><span class="s">"exchange_rates.yaml"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_get_exchange_rates_with_vcr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># assign
</span>    <span class="n">exchange_rates_client</span> <span class="o">=</span> <span class="n">ExchangeRatesClient</span><span class="p">()</span>

    <span class="c1"># act
</span>    <span class="n">result</span> <span class="o">=</span> <span class="n">exchange_rates_client</span><span class="p">.</span><span class="n">get_exchange_rates</span><span class="p">(</span><span class="s">"USD"</span><span class="p">)</span>

    <span class="c1"># assert
</span>    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">cassette</span><span class="p">.</span><span class="n">responses</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">"body"</span><span class="p">][</span><span class="s">"string"</span><span class="p">])</span>
</pre></table></code></div></div><p>PROS</p><ul><li>Easy to use<li>Flexibility<li>Stores real responses and is easy to record the complex ones that would be a nightmare to mock them manually<li>Ability to view those responses<li>Ability to hide/not record sensitive information like tokens/api keys etc<li>Easily record multiple calls within a test, which in normal cases would be hard to mock.</ul><p>CONS</p><ul><li>Every time there is a change in a request, that means that a response needs to be generated. But what happens if that response was time sensitive and changes in time? (Trick is to - manually tweak the request).<li>A live request is needed if the record mode is set to ONCE. Sometimes this is impossible.<li>Configuration can be daunting at first</ul><h2 id="conclusion">Conclusion</h2><p>So there you have it. When dealing with third parties there is a range of strategies that can fit to a variety of cases. Here at Beyond we prefer the feature rich and production-ready solution of the VCR library, since we are doing a heavy use of external requests. The other solutions proposed can also be an ideal approach, especially for simpler cases.</p></div><div class="post-tail-wrapper text-muted"><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Mocking requests to third party services - Engineering<br/> @ Beyond &url=https://1024inc.github.io/engineering-blog//posts/mocking-requests-to-third-party-services/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Mocking requests to third party services - Engineering<br/> @ Beyond &u=https://1024inc.github.io/engineering-blog//posts/mocking-requests-to-third-party-services/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Mocking requests to third party services - Engineering<br/> @ Beyond &url=https://1024inc.github.io/engineering-blog//posts/mocking-requests-to-third-party-services/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/llm-as-judge-e2e-testing-ai-agents/">End-to-End Testing for AI Agents with LLM as a Judge</a><li><a href="/posts/mocking-requests-to-third-party-services/">Mocking requests to third party services</a><li><a href="/posts/tools-to-backfill-large-postgresql-tables-pt1/">Tools to backfill large PostgreSQL tables (part 1)</a><li><a href="/posts/post-mortems-intro/">Post-mortems intro</a><li><a href="/posts/empathy-and-compassion-in-communication-part-1/">Empathy and Compassion in Communication (part 1)</a></ul></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/llm-as-judge-e2e-testing-ai-agents/"><div class="card-body"> <span class="timeago small" >Dec 25, 2025<i class="unloaded">2025-12-25T20:00:00-06:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>End-to-End Testing for AI Agents with LLM as a Judge</h3><div class="text-muted small"><p> The Testing Challenge AI agents are becoming critical infrastructure. From customer support to data analysis, organizations are deploying agents that make decisions, call APIs, and generate respon...</p></div></div></a></div><div class="card"> <a href="/posts/tools-to-backfill-large-postgresql-tables-pt1/"><div class="card-body"> <span class="timeago small" >May 31, 2022<i class="unloaded">2022-05-31T19:00:00-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Tools to backfill large PostgreSQL tables (part 1)</h3><div class="text-muted small"><p> At Beyond we are mainly using PostgreSQL databases for our services, consisting of over a hundred tables. With some of the largest ones we’ve already had a few close calls as they were reaching the...</p></div></div></a></div><div class="card"> <a href="/posts/empathy-and-compassion-in-communication-part-2/"><div class="card-body"> <span class="timeago small" >Apr 11, 2022<i class="unloaded">2022-04-11T23:00:00-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Empathy and Compassion in Communication (part 2)</h3><div class="text-muted small"><p> Effective engineers are strong problem solvers. Great engineers have also become inspiring leaders and master communicators. Whether you want to take your career to the next level, or simply aspi...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/tools-to-backfill-large-postgresql-tables-pt1/" class="btn btn-outline-primary" prompt="Older"><p>Tools to backfill large PostgreSQL tables (part 1)</p></a> <a href="/posts/llm-as-judge-e2e-testing-ai-agents/" class="btn btn-outline-primary" prompt="Newer"><p>End-to-End Testing for AI Agents with LLM as a Judge</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2026 <a href="https://twitter.com/BeyondPricing">Beyond Engineering</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
