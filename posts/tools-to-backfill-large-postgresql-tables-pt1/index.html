<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Tools to backfill large PostgreSQL tables (part 1)" /><meta name="author" content="Tamas Simak" /><meta property="og:locale" content="en" /><meta name="description" content="At Beyond we are mainly using PostgreSQL databases for our services, consisting of over a hundred tables. With some of the largest ones we’ve already had a few close calls as they were reaching the maximum supported 32TB table size - but that’s a story for another day. Backfilling tables that large is not a trivial task, assuming we want to perform it safely, and within a reasonable timeframe. In this post, we are going to outline a few methods and tools similar to what we have successfully used to make this process scalable, and a little less painful." /><meta property="og:description" content="At Beyond we are mainly using PostgreSQL databases for our services, consisting of over a hundred tables. With some of the largest ones we’ve already had a few close calls as they were reaching the maximum supported 32TB table size - but that’s a story for another day. Backfilling tables that large is not a trivial task, assuming we want to perform it safely, and within a reasonable timeframe. In this post, we are going to outline a few methods and tools similar to what we have successfully used to make this process scalable, and a little less painful." /><link rel="canonical" href="https://1024inc.github.io/engineering-blog//posts/tools-to-backfill-large-postgresql-tables-pt1/" /><meta property="og:url" content="https://1024inc.github.io/engineering-blog//posts/tools-to-backfill-large-postgresql-tables-pt1/" /><meta property="og:site_name" content="Engineering @ Beyond" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-05-31T19:00:00-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Tools to backfill large PostgreSQL tables (part 1)" /><meta name="twitter:site" content="@BeyondPricing" /><meta name="twitter:creator" content="@Tamas Simak" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Tamas Simak"},"dateModified":"2022-06-01T02:26:08-05:00","datePublished":"2022-05-31T19:00:00-05:00","description":"At Beyond we are mainly using PostgreSQL databases for our services, consisting of over a hundred tables. With some of the largest ones we’ve already had a few close calls as they were reaching the maximum supported 32TB table size - but that’s a story for another day. Backfilling tables that large is not a trivial task, assuming we want to perform it safely, and within a reasonable timeframe. In this post, we are going to outline a few methods and tools similar to what we have successfully used to make this process scalable, and a little less painful.","headline":"Tools to backfill large PostgreSQL tables (part 1)","mainEntityOfPage":{"@type":"WebPage","@id":"https://1024inc.github.io/engineering-blog//posts/tools-to-backfill-large-postgresql-tables-pt1/"},"url":"https://1024inc.github.io/engineering-blog//posts/tools-to-backfill-large-postgresql-tables-pt1/"}</script><title>Tools to backfill large PostgreSQL tables (part 1) | Engineering<br/> @ Beyond</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Engineering<br/> @ Beyond "><meta name="application-name" content="Engineering<br/> @ Beyond "><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/images/logo.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Engineering<br/> @ Beyond </a></div><div class="site-subtitle font-italic">Let's go Beyond together!</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/principles/" class="nav-link"> <i class="fa-fw fas fa-heartbeat ml-xl-3 mr-xl-3 unloaded"></i> <span>OUR PRINCIPLES</span> </a><li class="nav-item"> <a href="/obts/" class="nav-link"> <i class="fa-fw fas fa-users ml-xl-3 mr-xl-3 unloaded"></i> <span>DELIVERY TEAMS</span> </a><li class="nav-item"> <a href="/guilds/" class="nav-link"> <i class="fa-fw fas fa-lightbulb ml-xl-3 mr-xl-3 unloaded"></i> <span>GUILDS AND COMMUNITIES</span> </a><li class="nav-item"> <a href="/eng-paths/" class="nav-link"> <i class="fa-fw fas fa-users ml-xl-3 mr-xl-3 unloaded"></i> <span>ENGINEERING PATHS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/1024inc/" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/BeyondPricing" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['dev','beyondpricing.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Tools to backfill large PostgreSQL tables (part 1)</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Tools to backfill large PostgreSQL tables (part 1)</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Tamas Simak </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Tue, May 31, 2022, 7:00 PM -0500" >May 31, 2022<i class="unloaded">2022-05-31T19:00:00-05:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Wed, Jun 1, 2022, 9:26 AM +0200" >Jun 1, 2022<i class="unloaded">2022-06-01T02:26:08-05:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1457 words">8 min read</span></div></div><div class="post-content"><p>At Beyond we are mainly using PostgreSQL databases for our services, consisting of over a hundred tables. With some of the largest ones we’ve already had a few close calls as they were reaching the maximum supported 32TB table size - but that’s a story for another day. Backfilling tables that large is not a trivial task, assuming we want to perform it safely, and within a reasonable timeframe. In this post, we are going to outline a few methods and tools similar to what we have successfully used to make this process scalable, and a little less painful.</p><h2 id="whats-backfilling-and-why-can-it-be-a-problem">What’s backfilling and why can it be a problem?</h2><p>Backfilling simply means modifying or adding new data to existing database records, i.e. running <code class="language-plaintext highlighter-rouge">UPDATE</code> statements, but with an emphasis on performing it on all or most of the records in a table.</p><h3 id="when-would-it-be-needed">When would it be needed?</h3><ul><li>We want to modify a column’s value to fix faulty data<li>We have to add a new field, i.e. insert a new column to the table, with either a default value or with data computed by arbitrary business logic.</ul><p>In any case, the main issue is that if we want to perform a backfill on a seriously large table, it just simply takes a very long time. And by that I mean if we just naively issue an <code class="language-plaintext highlighter-rouge">UPDATE table SET field=value WHERE id=n</code> for each and every row, it will finish in weeks, months, or even years, depending on the use case’s context. In a specific case, we had to update a 22TB table with hundreds of billions of rows where the estimated time to completion was over 2 years.</p><p>With tables of this size, just creating a copy of the whole table and doing the update on it to avoid certain problems is not always a viable option, so we’ll focus on the use case where we really want to update the live table. The first challenge is to complete this process as quickly as possible, naturally. The second one is to accept that it won’t be quick enough, and come up with tools that make this task more controlled and manageable, while making sure our application can still operate on the table without major hiccups.</p><h2 id="what-can-we-do">What can we do?</h2><p>Our fictional scenario will be performed on a table named users. We’ll act like we have billions of users in our system. We want to backfill this table, inserting values into our newly created <code class="language-plaintext highlighter-rouge">reversed_last_name</code> column where we want to store our users’ last name, but, wait for it: reversed. And we want to do this because of, well, reasons. We will also pretend this is something that needs some calculations beforehand in a script and we couldn’t possibly do the update with just a snappy SQL expression (you know, like <code class="language-plaintext highlighter-rouge">REVERSE()</code>).</p><h3 id="lets-perform-the-update-in-batches">Let’s perform the update in batches</h3><p>Updating rows one by one puts a massive overhead on the process, and is the primary culprit for slowness. The solution seems simple enough: use as few individual <code class="language-plaintext highlighter-rouge">UPDATE</code> statements as possible. To do this, we want to write our data migration script so that it will output SQL which uses PostgreSQL’s <code class="language-plaintext highlighter-rouge">CASE</code> expression:</p><div class="language-sql highlighter-rouge"><div class="code-header"> <span text-data=" Sql "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="k">UPDATE</span> <span class="n">users</span> 
<span class="k">SET</span> <span class="n">reversed_last_name</span> <span class="o">=</span> <span class="p">(</span>
  <span class="k">CASE</span>
    <span class="k">WHEN</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">THEN</span> <span class="s1">'htulB'</span>
    <span class="k">WHEN</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">THEN</span> <span class="s1">'nasemraP'</span>
    <span class="k">WHEN</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">3</span> <span class="k">THEN</span> <span class="s1">'walboL'</span>
    <span class="p">[...]</span>
    <span class="k">ELSE</span> <span class="n">last_name</span>
  <span class="k">END</span>
<span class="p">)</span>
<span class="k">WHERE</span> <span class="n">id</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="k">AND</span> <span class="n">id</span> <span class="o">&lt;=</span> <span class="mi">500</span>
</pre></table></code></div></div><p>As you can see from the <code class="language-plaintext highlighter-rouge">WHERE</code> clause, we want to build update statements only for a subset of data. We might be tempted to build one huge <code class="language-plaintext highlighter-rouge">UPDATE</code> on all the rows, but there are a couple of issues with that. You’ll find that PostgreSQL puts an entire table lock on this huge table until the statement execution is completed, which unfortunately still won’t happen fast enough. Besides our application being denied write access to any rows, it would very likely cause a myriad of other issues. What works best is finding an equilibrium, and executing the updates in batches, balancing the number of rows affected in one batch, being aware that they will be locked while being updated, but processed and released from the lock in a reasonable amount of time.</p><p>To help us compose these batch operations, we’ll create a simple iterator class that will receive a database connection, the name of the table we want to backfill, the desired batch size, and an optional <code class="language-plaintext highlighter-rouge">start_batch</code> indicator that will come in handy later, when we implement a pause/resume feature and parallel processing. The class retrieves the max id of the table, and will yield us <code class="language-plaintext highlighter-rouge">id</code> boundaries according to the batch size, with a <code class="language-plaintext highlighter-rouge">begin_id</code> and an <code class="language-plaintext highlighter-rouge">end_id</code> which will help us build our select queries and batched update statements.</p><p><em>This is a simplified example and it assumes we have integer primary keys called id and we have a data set starting from id=1.</em></p><div class="language-python highlighter-rouge"><div class="code-header"> <span text-data=" Python "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">math</span>

<span class="k">class</span> <span class="nc">TableBatchIterator</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">start_batch</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">start_batch</span> <span class="o">=</span> <span class="n">start_batch</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">max_id</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">table_max_id</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">total_batches</span> <span class="o">=</span> <span class="n">math</span><span class="p">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">max_id</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">current_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">start_batch</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">current_batch</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="p">.</span><span class="n">total_batches</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">StopIteration</span>

        <span class="n">begin_id</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">current_batch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">batch_size</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">end_id</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">current_batch</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">max_id</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">current_batch</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">begin_id</span><span class="p">,</span> <span class="n">end_id</span><span class="p">)</span>
		
    <span class="o">@</span><span class="nb">staticmethod</span>
    <span class="k">def</span> <span class="nf">table_max_id</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="p">.</span><span class="n">conn</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="n">cursor</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s">'SELECT max(id) FROM </span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s">;'</span><span class="p">)</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">cursor</span><span class="p">.</span><span class="n">fetchone</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></table></code></div></div><p>To build the update statements shown above, we’ll also need something that takes the begin and end id values, the field name, and the new value. We’ll use a simple to use class for this.</p><p>The <code class="language-plaintext highlighter-rouge">BatchUpdateBuilder</code> class exposes two public methods: <code class="language-plaintext highlighter-rouge">update()</code>, which will be responsible for accumulating all the new values we want to persist for a given id and column name, and <code class="language-plaintext highlighter-rouge">build_sql()</code>, which will return the corresponding <code class="language-plaintext highlighter-rouge">UPDATE</code> SQL statement string with the <code class="language-plaintext highlighter-rouge">CASE/WHEN</code> expressions built from the values stored by <code class="language-plaintext highlighter-rouge">update()</code>. It will also append a <code class="language-plaintext highlighter-rouge">WHERE</code> clause to the statement to narrow down the scope to rows concerned in the given batch.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span text-data=" Python "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">json</span>

<span class="k">class</span> <span class="nc">BatchUpdateBuilder</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">begin_id</span><span class="p">,</span> <span class="n">end_id</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">table</span>
	  <span class="bp">self</span><span class="p">.</span><span class="n">begin_id</span> <span class="o">=</span> <span class="n">begin_id</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">end_id</span> <span class="o">=</span> <span class="n">end_id</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">updates</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_id</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">new_value</span><span class="p">):</span>
        <span class="n">field_updates</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">updates</span><span class="p">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">field_updates</span><span class="p">[</span><span class="n">_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_value</span>

    <span class="k">def</span> <span class="nf">build_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">begin_id</span><span class="p">,</span> <span class="n">end_id</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">.</span><span class="n">updates</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="n">sql</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s">'UPDATE </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">table</span><span class="si">}</span><span class="se">\\</span><span class="s">n'</span>
            <span class="sa">f</span><span class="s">'SET</span><span class="se">\\</span><span class="s">n</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">_build_cases</span><span class="p">()</span><span class="si">}</span><span class="se">\\</span><span class="s">n'</span>
            <span class="sa">f</span><span class="s">'WHERE </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">_build_where</span><span class="p">(</span><span class="n">begin_id</span><span class="p">,</span> <span class="n">end_id</span><span class="p">)</span><span class="si">}</span><span class="s">'</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">sql</span>

    <span class="k">def</span> <span class="nf">_build_cases</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cases</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">field_updates</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">updates</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">cases</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">_build_field_case</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">field_updates</span><span class="p">))</span>
        <span class="k">return</span> <span class="s">',</span><span class="se">\\</span><span class="s">n'</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">cases</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_field_case</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">field_updates</span><span class="p">):</span>
        <span class="n">cases</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_id</span><span class="p">,</span> <span class="n">new_value</span> <span class="ow">in</span> <span class="n">field_updates</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">cases</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s">'WHEN id = </span><span class="si">{</span><span class="n">_id</span><span class="si">}</span><span class="s"> THEN </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">_to_sql_value</span><span class="p">(</span><span class="n">new_value</span><span class="p">)</span><span class="si">}</span><span class="s">'</span><span class="p">)</span>

        <span class="n">cases</span> <span class="o">=</span> <span class="s">'</span><span class="se">\\</span><span class="s">n          '</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">cases</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s">'  </span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s"> = (</span><span class="se">\\</span><span class="s">n'</span>
            <span class="s">'       CASE</span><span class="se">\\</span><span class="s">n'</span>
            <span class="sa">f</span><span class="s">'          </span><span class="si">{</span><span class="n">cases</span><span class="si">}</span><span class="se">\\</span><span class="s">n'</span>
            <span class="sa">f</span><span class="s">'          ELSE </span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="se">\\</span><span class="s">n'</span>
            <span class="s">'       END</span><span class="se">\\</span><span class="s">n'</span>
            <span class="s">'  )'</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_where</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s">'id &gt;= </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">begin_id</span><span class="si">}</span><span class="s"> AND id &lt;= </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">end_id</span><span class="si">}</span><span class="s">'</span>

    <span class="o">@</span><span class="nb">staticmethod</span>
    <span class="k">def</span> <span class="nf">_to_sql_value</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s">'</span><span class="se">\\</span><span class="s">'</span><span class="p">{</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">)}</span>\\<span class="s">'::jsonb'</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s">'</span><span class="se">\\</span><span class="s">'</span><span class="p">{</span><span class="n">value</span><span class="p">}</span>\\<span class="s">''</span>
        <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">'null'</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</pre></table></code></div></div><p>With these in place, we can do something like this, demonstrating with a Django example:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span text-data=" Python "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">connection</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">BatchUpdateBuilder</span><span class="p">,</span> <span class="n">TableBatchIterator</span>

<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">TABLE_NAME</span> <span class="o">=</span> <span class="s">'users'</span>

<span class="n">table_batch_iterator</span> <span class="o">=</span> <span class="n">TableBatchIterator</span><span class="p">(</span>
    <span class="n">conn</span><span class="o">=</span><span class="n">connection</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="n">TABLE_NAME</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span>
<span class="p">)</span>

<span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="n">cursor</span><span class="p">()</span>

<span class="k">for</span> <span class="n">boundaries</span> <span class="ow">in</span> <span class="n">table_batch_iterator</span><span class="p">:</span>
    <span class="n">begin_id</span><span class="p">,</span> <span class="n">end_id</span> <span class="o">=</span> <span class="n">boundaries</span>
    <span class="n">batch_update_builder</span> <span class="o">=</span> <span class="n">BatchUpdateBuilder</span><span class="p">(</span><span class="n">TABLE_NAME</span><span class="p">,</span> <span class="n">begin_id</span><span class="p">,</span> <span class="n">end_id</span><span class="p">)</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">User</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">select_for_update</span><span class="p">().</span><span class="nb">filter</span><span class="p">(</span><span class="n">id__gte</span><span class="o">=</span><span class="n">begin_id</span><span class="p">,</span> <span class="n">id__lte</span><span class="o">=</span><span class="n">end_id</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
        <span class="n">reversed_last_name</span> <span class="o">=</span> <span class="n">user</span><span class="p">.</span><span class="n">last_name</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">batch_update_builder</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="nb">id</span><span class="p">,</span> <span class="s">'reversed_last_name'</span><span class="p">,</span> <span class="n">reversed_last_name</span><span class="p">)</span>

    <span class="n">sql</span> <span class="o">=</span> <span class="n">batch_update_builder</span><span class="p">.</span><span class="n">build_sql</span><span class="p">()</span>

    <span class="n">cursor</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

<span class="n">cursor</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</pre></table></code></div></div><p>Pretty straightforward. We create an instance of the <code class="language-plaintext highlighter-rouge">TableBatchIterator</code> instrumented to perform the updates in batches of 500 (at most, actual batch size may vary if rows with certain id values are missing) on our users table, then iterate through it to build and execute a bunch of <code class="language-plaintext highlighter-rouge">UPDATE</code> statements generated by the BatchUpdateBuilder.</p><h2 id="moving-forward">Moving forward</h2><p>In the second part of this blog post we’ll be going further, adding a <strong>progress calculator</strong> to help us monitor the status of the process, and as a last step we will create a lightweight <strong>queue system</strong> that makes it possible to run the task in parallel processes while also allowing us to pause and resume the process on demand.</p></div><div class="post-tail-wrapper text-muted"><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Tools to backfill large PostgreSQL tables (part 1) - Engineering<br/> @ Beyond &url=https://1024inc.github.io/engineering-blog//posts/tools-to-backfill-large-postgresql-tables-pt1/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Tools to backfill large PostgreSQL tables (part 1) - Engineering<br/> @ Beyond &u=https://1024inc.github.io/engineering-blog//posts/tools-to-backfill-large-postgresql-tables-pt1/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Tools to backfill large PostgreSQL tables (part 1) - Engineering<br/> @ Beyond &url=https://1024inc.github.io/engineering-blog//posts/tools-to-backfill-large-postgresql-tables-pt1/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/llm-as-judge-e2e-testing-ai-agents/">End-to-End Testing for AI Agents with LLM as a Judge</a><li><a href="/posts/mocking-requests-to-third-party-services/">Mocking requests to third party services</a><li><a href="/posts/tools-to-backfill-large-postgresql-tables-pt1/">Tools to backfill large PostgreSQL tables (part 1)</a><li><a href="/posts/post-mortems-intro/">Post-mortems intro</a><li><a href="/posts/empathy-and-compassion-in-communication-part-1/">Empathy and Compassion in Communication (part 1)</a></ul></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/llm-as-judge-e2e-testing-ai-agents/"><div class="card-body"> <span class="timeago small" >Dec 25, 2025<i class="unloaded">2025-12-25T20:00:00-06:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>End-to-End Testing for AI Agents with LLM as a Judge</h3><div class="text-muted small"><p> The Testing Challenge AI agents are becoming critical infrastructure. From customer support to data analysis, organizations are deploying agents that make decisions, call APIs, and generate respon...</p></div></div></a></div><div class="card"> <a href="/posts/mocking-requests-to-third-party-services/"><div class="card-body"> <span class="timeago small" >Aug 9, 2022<i class="unloaded">2022-08-09T19:00:00-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Mocking requests to third party services</h3><div class="text-muted small"><p> Third party services are frequently used to extend the functionality of our product/service, especially in cases where what is needed grows beyond the limits of our industry or purpose. Once an int...</p></div></div></a></div><div class="card"> <a href="/posts/empathy-and-compassion-in-communication-part-2/"><div class="card-body"> <span class="timeago small" >Apr 11, 2022<i class="unloaded">2022-04-11T23:00:00-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Empathy and Compassion in Communication (part 2)</h3><div class="text-muted small"><p> Effective engineers are strong problem solvers. Great engineers have also become inspiring leaders and master communicators. Whether you want to take your career to the next level, or simply aspi...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/empathy-and-compassion-in-communication-part-2/" class="btn btn-outline-primary" prompt="Older"><p>Empathy and Compassion in Communication (part 2)</p></a> <a href="/posts/mocking-requests-to-third-party-services/" class="btn btn-outline-primary" prompt="Newer"><p>Mocking requests to third party services</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2026 <a href="https://twitter.com/BeyondPricing">Beyond Engineering</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
